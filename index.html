<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Solver</title>
</head>

<body>
  <form id="equation-form">
    <input id="equation">
    <button type="submit">Solve</button>
  </form>
  <div id="results"></div>
  <script>

    // ==================== Variables

    const form = document.querySelector('#equation-form')
    const input = document.querySelector('#equation')
    const res = document.querySelector('#results')
    const string1 = '1+2+3+4324/23434-424*111'
    const string2 = string1
    const bodmas = [
      {
        name: 'division',
        rule: '/'
      },
      {
        name: 'multiplication',
        rule: '*'
      },
      {
        name: 'addition',
        rule: '+'
      },
      {
        name: 'subtraction',
        rule: '-'
      },
    ]


    // ==================== Event Listeners And Function Calls

    form.addEventListener('submit', e => {
      e.preventDefault()
      const inputString = input.value
      const result = executeStringOperations(inputString)
      res.innerText = result
    })


    // ==================== Function Definitions

    function executeStringOperations(str) {
      let startFrom = 0

      while (hasBrackets(str)) {
        const { res, newCounter } = getStringBetweenBrackets(str, startFrom)
        const substr = str.substring(startFrom, newCounter + 1)
        str = str.replace(substr, res)
        startFrom = res.length
      }

      str = evaluateString(str)

      return str
    }

    function getStringBetweenBrackets(str, startFrom) {
      let counter = startFrom
      let start = false
      let newStr = ''
      let bracketedString = ''

      while (counter < str.length) {
        if (start && str[counter] === '(') {
          const { res, newCounter } = getStringBetweenBrackets(str.substr(counter), 0)
          bracketedString += res
          counter += (newCounter + 1)
        }
        if (str[counter] === '(') {
          start = true
        }
        if (start && str[counter] === ')') {
          start = false
          bracketedString = evaluateString(bracketedString)
          break
        }
        if (start && !['(', ')'].includes(str[counter])) {
          bracketedString += str[counter]
        } else if (!start && !['(', ')'].includes(str[counter])) {
          newStr += str[counter]
        }

        counter += 1
      }

      newStr += bracketedString

      return { res: newStr, newCounter: counter }
    }

    function evaluateString(string) {
      let equString = string

      for (let expr of bodmas) {
        const regExpGlobal = extractOperandAndOperatorStringRegexGlobal(equString, expr.rule)
        let res

        while (res = regExpGlobal.exec(equString)) {
          let a = seperateDigitsAndRule(res[0], expr.rule)
          const ans = calculateEquation(a, expr.rule)
          const regExp = extractOperandAndOperatorStringRegex(equString, expr.rule)
          equString = equString.replace(regExp, ans)
          regExpGlobal.lastIndex = 0
        }

      }

      return equString
    }

    function extractOperandAndOperatorStringRegexGlobal(string, rule) {
      return new RegExp(`(\\-)??\\d+(\\.{1}\\d+)?[ ]?\\${rule}[ ]?\\d+(\\.{1}\\d+)?`, 'g')
    }
    function extractOperandAndOperatorStringRegex(string, rule) {
      return new RegExp(`(\\-)??\\d+(\\.{1}\\d+)?[ ]?\\${rule}[ ]?\\d+(\\.{1}\\d+)?`)
    }

    function seperateDigitsAndRule(string, rule) {
      const regExp = /(\-{1})?[ ]?\d+(\.\d+)?/g
      return string.match(regExp)
    }

    function hasBrackets(str) {
      const regExp = /\(/g
      return regExp.test(str)
    }

    function calculateEquation(digitsArray, rule) {
      let ans = 0
      switch (rule) {
        case '/':
          ans = parseFloat(digitsArray[0]) / parseFloat(digitsArray[1])
          break
        case '*':
          ans = parseFloat(digitsArray[0]) * parseFloat(digitsArray[1])
          break
        case '+':
          ans = parseFloat(digitsArray[0]) + parseFloat(digitsArray[1])
          break
        case '-':
          ans = parseFloat(digitsArray[0]) - Math.abs(parseFloat(digitsArray[1]))
          break
      }

      return ans
    }
  </script>
</body>

</html>